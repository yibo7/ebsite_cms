# 项目部署
以下三种方式均可以部署本项目，其中Vercel最为简单且免服务器。

# 一、docker下运行(推荐):

>部署前建议将conf/setting.json下的IsVercel修改为False，这样默认会使用内存缓存更快。

linux下运行建议使用docker， 在docker下是通过uwsgi来运行本项目，使用uwsgi配合gevent大大提高项目的并发与性能。

docker下运行的的前提是，你已经在linux上安装了docker与docker-compose,那么只要在项目的根目录下执行以下命令即可：
  > docker-compose up -d

具体请参考以下步骤：

- ### 1.打包项目并上传linux主机解压
  一般使用tar或tar.gz格式，使用7-zip即可
- ### 2.修改项目的运行端口（可选）
  项目默认使用8066端口运行，并对外映射的端口也是8066，如果你需要修改些值，请修改
  conf/setting.json中的Port。
  但以上只是修改了项目运行的端口，你还要相应地修改docker映射端口，
  在项目的根目录下打开docker-compose.yml，并修改里面的ports:
  ```yml
      ports:
        - "80:8066"  # 80是linux主机对外可访问的端口，8066这个要与conf/setting.json中的Port一致。
  ```
- ### 3.docker 网络名称修改（可选）
  在项目的根目录下打开docker-compose中创建容器的示例网络是
  1panel-networ，这是1panel的容器网络名称，你如果不使用1panel管理面板，也可以修改成其他的。
  ```yml
    networks:
      - 1panel-network
  ```

- ### 4.修改运行方式（可选）
  在生产模式下，默认采用gevent运行项目，gevent可以应对大多小中小型网站，不过你的服务器性能比较好，比如4核4G及以下，可以采用uwsgi来运行能更大提高性能：
  - ##### 4.1 用gevent运行项目
  
      在 Dockerfile 中运行项目直接：CMD python index.py，
      但要将index.py中的，app = create_app("dev")，修改为 app = create_app("pro")
  - ##### 4.2 用uwsgi运行
    - 1).在requirements.txt 下添加uwsgi库：
     > uwsgi
  
    - 2).修改Dockerfile:
      - 注释掉命令 :CMD python index.py
      - 采用命令: CMD ["uwsgi", "--ini", "uwsgi.ini"]
  
      ```
        通过心个两步即可往下，但你也可以修改uwsgi的运行参数，
        具体参考根目录下的：uwsgi.ini,访问uwsgi服务器信息, 
        以上uwsgi配置文件上stats指定的端口可以访问到uwsgi服务器信息，
        不过要进入到docker终端。
        执行命令如下：uwsgi --connect-and-read 127.0.0.1:8067
      ```


- ### 5.启动服务-构建镜像与运行容器
  在linux上，cd 到项目的根目录下，执行以下命令：
  > docker-compose up -d   

  国内服务器可修改python仓库源提快速度，修改Dockerfile文件，将：
  > RUN pip install -r requirements.txt
  
  修改为：

  > RUN pip install -i https://pypi.tuna.tsinghua.edu.cn/simple --no-cache-dir -r requirements.txt

- ### 6.访问页面
  - 首页
     > http://你的IP:你的端口(80)
  - 后台管理登录页面

    后台管理登录页面（第一次访问会初始默认数据）：
    > http://你的IP:你的端口(80)/login_ad
  
- ### 7.代码的维护与修改
  默认的docker-compose.yml，将当前目录映射到容器的app目录下，你可以直接修改当前目录的文件即可。
  也就是说，你可以直接修改解压后的那个目录下的项目文件，因为这里与容器运行的项目文件是同一个。
 

  
  虽然是直接运行，如果是在生产环境，使用的是gevent，配合nginx也能获得较好的性能。


# 二、windows 下运行
>部署前建议将conf/setting.json下的IsVercel修改为False，这样默认会使用内存缓存更快。

- ### 1.安装python及依赖库

  目前python 运行 3.9 以上，推荐使用3.12 及以上。
  
  删除requirements.txt下的uwsgi 执行:
  > pip install -r requirements.txt

  因为windows下无法安装uwsgi，所以windows下直接运行项目,

- ### 2.运行项目

  你可以通过修改conf/setting.json，将Port修改成你想要的端口，将IsDebug修改成false,这将在生产环境下运行。
  运行以下命令：
  > python index.py
 
# 三、用Vercel快速部署

>部署前请将conf/setting.json下的IsVercel修改为True。

### 1、点击以下按钮进入部署界面

  [![Deploy with Vercel](https://vercel.com/button)](https://vercel.com/new/clone?repository-url=https%3A%2F%2Fgithub.com%2Fyibo7%2Febsite_py.git&env=SITE_KEY,MONGODB_SERV&envDescription=SITE_KEY%E6%98%AF%E7%BD%91%E7%AB%99%E5%AF%86%E9%92%A5%2CMONGODB_SERV%E6%98%AFMongoDb%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E5%9C%B0%E5%9D%80&project-name=ebsite_py&repository-name=ebsite_py)

### 2、选择你的github账号，并创建项目
### 3、填写环境变量
  - MONGODB_SERV（MongoDb数据库连接串）   
    如果想保留setting.json上配置的数据库连接串，可将MONGODB_SERV设置为空。

### 4、初始化默认数据及演示数据    
    打开后台登录页面:https://你的域名/admin/login_ad
    这里会自动完成数据的初始化，然后你可以使用以下账号密码登录后台:
    - user: admin
    - pass: ebsite111111

### 5、用Redis缓存做缓存（可选）

    这是一个可选方案，在vercel上无法使用内存做缓存，默认情况下使用MongoDb做缓存。
    如果你希望提交缓存性能，可能采用Redis做缓存，只需修改conf/setting.json的REDIS_SERV即可。
 
### 6、注意事项
    在vercel上运行项目有一定限制，因为vercel平台是无状态服务，且没有文件写入权限。
    这意义着在vercel上运行项目，你将无法操作：
    - 1、默认使用Mongdb做缓存（无法使用内存缓存，但可更换为Redis缓存）
    - 2、在后台更换主题
    - 3、无法使用【文件上传-本地】插件
    - 4、无法在后台备份数据库